{% extends "base.html" %}

{% block title %}MOP Management - System Checklist Tool{% endblock %}

{% block page_title %}MOP Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">MOP Management</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks mr-2"></i>
                    Method of Procedure (MOP) Management
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary" onclick="showCreateMOPModal()">
                        <i class="fas fa-plus mr-2"></i>Create New MOP
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if mops %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Commands</th>
                                <th>Status</th>
                                <th>Created By</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mop in mops %}
                            <tr>
                                <td>
                                    <strong>{{ mop.name }}</strong>
                                    {% if mop.description %}
                                    <br><small class="text-muted">{{ mop.description }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if mop.risk_assessment %}
                                        <span class="badge badge-warning">Risk Assessment</span>
                                    {% endif %}
                                    {% if mop.handover_assessment %}
                                        <span class="badge badge-info">Handover Assessment</span>
                                    {% endif %}
                                </td>
                                <td>{{ mop.commands|length }} commands</td>
                                <td>
                                    {% if mop.status == 'APPROVED' %}
                                        <span class="badge badge-success">Approved</span>
                                    {% elif mop.status == 'PENDING_APPROVAL' %}
                                        <span class="badge badge-warning">Pending</span>
                                    {% else %}
                                        <span class="badge badge-danger">Rejected</span>
                                    {% endif %}
                                </td>
                                <td>{{ mop.created_by.username if mop.created_by else 'Unknown' }}</td>
                                <td>{{ mop.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-info" onclick="viewMOP('{{ mop.id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="editMOP('{{ mop.id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteMOP('{{ mop.id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No MOPs Available</h5>
                    <p class="text-muted">No MOPs have been created yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- MOP Modal -->
<div class="modal fade" id="mopModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document" style="max-width: 95vw; width: 95vw; margin: 1rem auto;">
        <div class="modal-content" style="height: 90vh; max-height: 90vh;">
            <div class="modal-header">
                <h5 class="modal-title" id="mopModalTitle">Create New MOP</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                <form id="mopForm">
                    <input type="hidden" id="mopId" name="mop_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="mopName">MOP Name *</label>
                                <input type="text" class="form-control" id="mopName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="mopDescription">Description</label>
                                <input type="text" class="form-control" id="mopDescription" name="description">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>MOP Type *</label>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="riskAssessment" name="risk_assessment">
                                    <label class="custom-control-label" for="riskAssessment">Risk Assessment</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="handoverAssessment" name="handover_assessment">
                                    <label class="custom-control-label" for="handoverAssessment">Handover Assessment</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <h6>Commands</h6>
                            <button type="button" class="btn btn-sm btn-success" onclick="addCommand()">
                                <i class="fas fa-plus mr-2"></i>Add Command
                            </button>
                        </div>
                    </div>
                    
                    <div id="commandsContainer" class="mt-3">
                        <!-- Commands will be added here -->
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <h6>MOP Preview</h6>
                            <div id="mopPreview" class="border p-3 bg-light">
                                <p class="text-muted">Commands will appear here as you add them...</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMOP()">
                    <i class="fas fa-save mr-2"></i>Save MOP
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MOP Detail Modal -->
<div class="modal fade" id="mopDetailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">MOP Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="mopDetailContent">
                    <!-- MOP details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <div id="mopActionButtons" style="display: none;">
                    <button type="button" class="btn btn-success" onclick="approveMOPFromModal()">Approve MOP</button>
                    <button type="button" class="btn btn-danger" onclick="rejectMOPFromModal()">Reject MOP</button>
                </div>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this MOP?</p>
                <p><strong id="deleteMopName"></strong></p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteMOP()">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
window.currentMopId = null;
let commandCounter = 0;

function viewMOP(mopId) {
    fetch(`/api/mops/${mopId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.currentViewMopId = mopId;
                displayMOPDetail(data.mop);
                
                // Show approve/reject buttons for admin if MOP is pending approval
                const actionButtons = document.getElementById('mopActionButtons');
                if (data.mop.status === 'PENDING_APPROVAL' && {{ 'true' if current_user.role == 'admin' else 'false' }}) {
                    actionButtons.style.display = 'block';
                } else {
                    actionButtons.style.display = 'none';
                }
                
                $('#mopDetailModal').modal('show');
            } else {
                showAlert('error', 'Error loading MOP details');
            }
        })
        .catch(error => {
            console.error('Error loading MOP details:', error);
            showAlert('error', 'Error loading MOP details');
        });
}

function editMOP(mopId) {
    window.currentMopId = mopId;
    
    fetch(`/api/mops/${mopId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const mop = data.mop;
                $('#mopModalTitle').text('Edit MOP');
                $('#mopId').val(mopId);
                $('#mopName').val(mop.name);
                $('#mopDescription').val(mop.description || '');
                $('#riskAssessment').prop('checked', mop.type && mop.type.includes('risk'));
                $('#handoverAssessment').prop('checked', mop.type && mop.type.includes('handover'));
                
                $('#commandsContainer').empty();
                commandCounter = 0;
                
                // Create table structure for commands
                let tableHtml = `
                    <div class="table-responsive">
                        <table class="table table-bordered" id="commandsTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th style="width: 8%;">STT</th>
                                    <th style="width: 25%;">Tên Command</th>
                                    <th style="width: 35%;">Câu lệnh</th>
                                    <th style="width: 25%;">Giá trị đối chiếu</th>
                                    <th style="width: 7%;">Xóa</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                mop.commands.forEach((command, index) => {
                    commandCounter++;
                    tableHtml += `
                        <tr class="command-item" data-command-id="${commandCounter}">
                            <td class="text-center align-middle">${index + 1}</td>
                            <td>
                                <input type="text" class="form-control" name="commands[${commandCounter}][title]" 
                                       value="${command.title}" required onchange="updatePreview()">
                            </td>
                            <td>
                                <textarea class="form-control command-input" name="commands[${commandCounter}][command]" 
                                          rows="2" required onchange="updatePreview()">${command.command}</textarea>
                            </td>
                            <td>
                                <textarea class="form-control" name="commands[${commandCounter}][expected_output]" 
                                          rows="2" onchange="updatePreview()">${command.reference_value || ''}</textarea>
                            </td>
                            <td class="text-center align-middle">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeCommand(${commandCounter})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                $('#commandsContainer').html(tableHtml);
                
                updatePreview();
                $('#mopModal').modal('show');
            } else {
                showAlert('error', 'Error loading MOP for editing');
            }
        })
        .catch(error => {
            console.error('Error loading MOP for editing:', error);
            showAlert('error', 'Error loading MOP for editing');
        });
}

let deleteMopId = null;

function deleteMOP(mopId) {
    console.log('deleteMOP called with mopId:', mopId);
    
    // Store the MOP ID for later use
    deleteMopId = mopId;
    
    // Get MOP name for display in modal
    fetch(`/api/mops/${mopId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('deleteMopName').textContent = data.mop.name;
                $('#deleteConfirmModal').modal('show');
            } else {
                showAlert('error', 'Error loading MOP details');
            }
        })
        .catch(error => {
            console.error('Error loading MOP details:', error);
            showAlert('error', 'Error loading MOP details');
        });
}

function confirmDeleteMOP() {
    if (deleteMopId) {
        console.log('User confirmed deletion for MOP ID:', deleteMopId);
        
        fetch(`/api/mops/${deleteMopId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Delete response data:', data);
            $('#deleteConfirmModal').modal('hide');
            if (data.success) {
                showAlert('success', 'MOP deleted successfully');
                location.reload();
            } else {
                showAlert('error', data.error || 'Error deleting MOP');
            }
        })
        .catch(error => {
            console.error('Error deleting MOP:', error);
            $('#deleteConfirmModal').modal('hide');
            showAlert('error', 'Error deleting MOP: ' + error.message);
        });
        
        // Reset the stored MOP ID
        deleteMopId = null;
    }
}

function showCreateMOPModal() {
    window.currentMopId = null;
    $('#mopModalTitle').text('Create New MOP');
    $('#mopForm')[0].reset();
    
    // Initialize empty table for commands
    const tableHtml = `
        <div class="table-responsive">
            <table class="table table-bordered" id="commandsTable">
                <thead class="thead-dark">
                    <tr>
                        <th style="width: 8%;">STT</th>
                        <th style="width: 25%;">Tên Command</th>
                        <th style="width: 35%;">Câu lệnh</th>
                        <th style="width: 25%;">Giá trị đối chiếu</th>
                        <th style="width: 7%;">Xóa</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    `;
    $('#commandsContainer').html(tableHtml);
    
    commandCounter = 0;
    updatePreview();
    $('#mopModal').modal('show');
}

function addCommand() {
    commandCounter++;
    
    // Check if table exists, if not create it
    if ($('#commandsTable').length === 0) {
        const tableHtml = `
            <div class="table-responsive">
                <table class="table table-bordered" id="commandsTable">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 8%;">STT</th>
                            <th style="width: 25%;">Tên Command</th>
                            <th style="width: 35%;">Câu lệnh</th>
                            <th style="width: 25%;">Giá trị đối chiếu</th>
                            <th style="width: 7%;">Xóa</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        `;
        $('#commandsContainer').html(tableHtml);
    }
    
    // Get current row count for STT
    const rowCount = $('#commandsTable tbody tr').length + 1;
    
    const rowHtml = `
        <tr class="command-item" data-command-id="${commandCounter}">
            <td class="text-center align-middle">${rowCount}</td>
            <td>
                <input type="text" class="form-control" name="commands[${commandCounter}][title]" 
                       placeholder="Command Title" required onchange="updatePreview()">
            </td>
            <td>
                <textarea class="form-control command-input" name="commands[${commandCounter}][command]" 
                          rows="2" placeholder="Enter command" required onchange="updatePreview()"></textarea>
            </td>
            <td>
                <textarea class="form-control" name="commands[${commandCounter}][expected_output]" 
                          rows="2" placeholder="Expected output for validation" onchange="updatePreview()"></textarea>
            </td>
            <td class="text-center align-middle">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeCommand(${commandCounter})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;
    $('#commandsTable tbody').append(rowHtml);
    updatePreview();
}

function removeCommand(commandId) {
    $(`.command-item[data-command-id="${commandId}"]`).remove();
    
    // Update STT numbers after removal
    $('#commandsTable tbody tr').each(function(index) {
        $(this).find('td:first').text(index + 1);
    });
    
    updatePreview();
}

function updatePreview() {
    const preview = $('#mopPreview');
    const commands = [];
    
    $('.command-item').each(function() {
        const title = $(this).find('input[name*="[title]"]').val();
        const command = $(this).find('textarea[name*="[command]"]').val();
        const expectedOutput = $(this).find('textarea[name*="[expected_output]"]').val();
        
        if (title && command) {
            commands.push({
                title: title,
                command: command,
                expectedOutput: expectedOutput
            });
        }
    });
    
    if (commands.length === 0) {
        preview.html('<p class="text-muted">Commands will appear here as you add them...</p>');
        return;
    }
    
    let previewHtml = `
        <div class="mop-preview-content">
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 8%;">STT</th>
                            <th style="width: 25%;">Tên Command</th>
                            <th style="width: 35%;">Câu lệnh</th>
                            <th style="width: 32%;">Giá trị đối chiếu</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    commands.forEach((cmd, index) => {
        previewHtml += `
            <tr>
                <td class="text-center">${index + 1}</td>
                <td><strong>${cmd.title}</strong></td>
                <td><code class="text-wrap">${cmd.command}</code></td>
                <td><small class="text-muted">${cmd.expectedOutput || 'N/A'}</small></td>
            </tr>
        `;
    });
    
    previewHtml += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    preview.html(previewHtml);
}

function saveMOP() {
    const formData = new FormData($('#mopForm')[0]);
    
    const type = [];
    if ($('#riskAssessment').is(':checked')) type.push('risk');
    if ($('#handoverAssessment').is(':checked')) type.push('handover');
    
    const mopData = {
        name: $('#mopName').val(),
        description: $('#mopDescription').val(),
        type: type,
        commands: []
    };
    
    $('.command-item').each(function() {
        const title = $(this).find('input[name*="[title]"]').val();
        const command = $(this).find('textarea[name*="[command]"]').val();
        const expectedOutput = $(this).find('textarea[name*="[expected_output]"]').val();
        
        if (title && command) {
            mopData.commands.push({
                title: title,
                command: command,
                reference_value: expectedOutput
            });
        }
    });
    
    if (!mopData.name) {
        showAlert('warning', 'Please enter MOP name');
        return;
    }
    
    if (mopData.type.length === 0) {
        showAlert('warning', 'Please select at least one MOP type');
        return;
    }
    
    if (mopData.commands.length === 0) {
        showAlert('warning', 'Please add at least one command');
        return;
    }
    
    const url = window.currentMopId ? `/api/mops/${window.currentMopId}` : '/api/mops';
    const method = window.currentMopId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(mopData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#mopModal').modal('hide');
            showAlert('success', window.currentMopId ? 'MOP updated successfully' : 'MOP created successfully');
            location.reload();
        } else {
            showAlert('error', data.error || 'Error saving MOP');
        }
    })
    .catch(error => {
        console.error('Error saving MOP:', error);
        showAlert('error', 'Error saving MOP');
    });
}

function displayMOPDetail(mop) {
    const container = document.getElementById('mopDetailContent');
    
    let html = `
        <div class="row mb-3">
            <div class="col-md-6">
                <h6>MOP Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Name:</strong></td><td>${mop.name}</td></tr>
                    <tr><td><strong>Description:</strong></td><td>${mop.description || 'N/A'}</td></tr>
                    <tr><td><strong>Status:</strong></td><td>
                        <span class="badge badge-${mop.status === 'APPROVED' ? 'success' : mop.status === 'PENDING_APPROVAL' ? 'warning' : 'danger'}">
                            ${mop.status}
                        </span>
                    </td></tr>
                    <tr><td><strong>Type:</strong></td><td>
                        ${mop.risk_assessment ? '<span class="badge badge-warning">Risk Assessment</span>' : ''}
                        ${mop.handover_assessment ? '<span class="badge badge-info">Handover Assessment</span>' : ''}
                    </td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Commands (${mop.commands.length})</h6>
            </div>
        </div>
    `;
    
    // Create table for commands
    html += `
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th style="width: 8%;">STT</th>
                        <th style="width: 25%;">Tên Command</th>
                        <th style="width: 35%;">Câu lệnh</th>
                        <th style="width: 32%;">Giá trị đối chiếu</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    mop.commands.forEach((command, index) => {
        html += `
            <tr>
                <td class="text-center">${index + 1}</td>
                <td><strong>${command.title}</strong></td>
                <td><code class="text-wrap">${command.command}</code></td>
                <td><small class="text-muted">${command.reference_value || 'N/A'}</small></td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// showAlert function is now global in base.html

function approveMOPFromModal() {
    if (window.currentViewMopId && confirm('Are you sure you want to approve this MOP?')) {
        fetch(`/api/mops/${window.currentViewMopId}/review`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: 'APPROVED'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#mopDetailModal').modal('hide');
                showAlert('success', 'MOP approved successfully');
                location.reload();
            } else {
                showAlert('error', data.error || 'Error approving MOP');
            }
        })
        .catch(error => {
            console.error('Error approving MOP:', error);
            showAlert('error', 'Error approving MOP');
        });
    }
}

function rejectMOPFromModal() {
    if (window.currentViewMopId) {
        const reason = prompt('Please provide a reason for rejection:');
        if (reason !== null) {
            fetch(`/api/mops/${window.currentViewMopId}/review`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: 'REJECTED',
                    reject_reason: reason
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#mopDetailModal').modal('hide');
                    showAlert('success', 'MOP rejected successfully');
                    location.reload();
                } else {
                    showAlert('error', data.error || 'Error rejecting MOP');
                }
            })
            .catch(error => {
                console.error('Error rejecting MOP:', error);
                showAlert('error', 'Error rejecting MOP');
            });
        }
    }
}
</script>
{% endblock %}
