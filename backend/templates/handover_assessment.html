{% extends "base.html" %}

{% block title %}Handover Assessment - System Checklist Tool{% endblock %}

{% block page_title %}Handover Assessment{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Handover Assessment</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-exchange-alt mr-2"></i>
                    Handover Assessment MOPs
                </h3>
            </div>
            <div class="card-body">
                {% if mops %}
                <div class="form-group">
                    <label for="mopSelect"><strong>Chọn MOP:</strong></label>
                    <select class="form-control" id="mopSelect" onchange="loadMOPCommands()">
                        <option value="">-- Chọn MOP --</option>
                        {% for mop in mops %}
                        <option value="{{ mop.id }}" data-mop="{{ mop.id }}">{{ mop.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="mopCommandsDisplay" class="mt-4" style="display: none;">
                    <h5>Commands trong MOP: <span id="selectedMOPName"></span></h5>
                    <div id="commandsList" class="border p-3 bg-light">
                        <!-- Commands will be loaded here -->
                    </div>
                </div>
                
                <div class="mt-4">
                    <button class="btn btn-primary" onclick="selectCurrentMOP()" id="selectMOPBtn" style="display: none;">
                        <i class="fas fa-play mr-2"></i>Thực thi MOP đã chọn
                    </button>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Handover Assessment MOPs Available</h5>
                    <p class="text-muted">No approved MOPs for handover assessment are currently available.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- MOP Execution Modal -->
<div class="modal fade" id="mopExecutionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Execute Handover Assessment</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="executionForm">
                    <input type="hidden" id="selectedMopId" name="mop_id">
                    
                    <div class="form-group">
                        <label for="serverList">Select Servers</label>
                        <div id="serverList" class="border p-3" style="max-height: 300px; overflow-y: auto;">
                            <!-- Server list will be populated dynamically -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Server Input</label>
                        <div class="row">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-primary btn-block mb-2" onclick="showFileUpload()">
                                    <i class="fas fa-upload mr-2"></i>Upload Server List
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-secondary btn-block mb-2" onclick="showManualInput()">
                                    <i class="fas fa-edit mr-2"></i>Manual Input
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-info btn-block mb-2" onclick="showTestConnection()">
                                    <i class="fas fa-plug mr-2"></i>Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeMOP()">
                    <i class="fas fa-play mr-2"></i>Execute Assessment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- File Upload Modal -->
<div class="modal fade" id="fileUploadModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Server List</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="serverFile">Select File (Excel/CSV)</label>
                    <input type="file" class="form-control-file" id="serverFile" accept=".xlsx,.xls,.csv">
                    <small class="form-text text-muted">Upload Excel or CSV file with server information</small>
                </div>
                <div class="mt-3">
                    <a href="/api/template/download" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-download mr-1"></i>Download Template
                    </a>
                </div>
                <div class="mt-3">
                    <a href="/api/template/download" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-download mr-1"></i>Download Template
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadServerFile()">
                    <i class="fas fa-upload mr-2"></i>Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manual Input Modal -->
<div class="modal fade" id="manualInputModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manual Server Input</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="manualServerForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="serverIP">Server IP</label>
                                <input type="text" class="form-control" id="serverIP" placeholder="192.168.1.100" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="adminUsername">Admin Username</label>
                                <input type="text" class="form-control" id="adminUsername" placeholder="admin" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="adminPassword">Admin Password</label>
                                <input type="password" class="form-control" id="adminPassword" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="rootUsername">Root Username</label>
                                <input type="text" class="form-control" id="rootUsername" placeholder="root" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="rootPassword">Root Password</label>
                                <input type="password" class="form-control" id="rootPassword" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-info btn-block" onclick="testServerConnection()">
                                    <i class="fas fa-plug mr-2"></i>Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addManualServer()">
                    <i class="fas fa-plus mr-2"></i>Add Server
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Connection Modal -->
<div class="modal fade" id="testConnectionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Server Connection</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="testConnectionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="testServerIP">Server IP</label>
                                <input type="text" class="form-control" id="testServerIP" placeholder="192.168.1.100" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="testAdminUsername">Admin Username</label>
                                <input type="text" class="form-control" id="testAdminUsername" placeholder="admin" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="testAdminPassword">Admin Password</label>
                                <input type="password" class="form-control" id="testAdminPassword" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="testRootUsername">Root Username</label>
                                <input type="text" class="form-control" id="testRootUsername" placeholder="root" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="testRootPassword">Root Password</label>
                                <input type="password" class="form-control" id="testRootPassword" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-info btn-block" onclick="performConnectionTest()">
                                    <i class="fas fa-plug mr-2"></i>Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="testResult" class="mt-3" style="display: none;">
                    <!-- Test result will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Execution Results Modal -->
<div class="modal fade" id="executionResultsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Execution Results</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="executionResults">
                    <!-- Results will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="exportResults()">
                    <i class="fas fa-download mr-2"></i>Export Results
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// State persistence
const STATE_KEY = 'handover_assessment_state';

// Load state on page load
document.addEventListener('DOMContentLoaded', function() {
    loadState();
});

function saveState() {
    const state = {
        selectedMopId: document.getElementById('mopSelect').value,
        servers: window.currentServers || [],
        commands: window.currentCommands || []
    };
    localStorage.setItem(STATE_KEY, JSON.stringify(state));
}

function loadState() {
    const savedState = localStorage.getItem(STATE_KEY);
    if (savedState) {
        const state = JSON.parse(savedState);
        if (state.selectedMopId) {
            document.getElementById('mopSelect').value = state.selectedMopId;
            loadMOPCommands();
        }
        if (state.servers) {
            window.currentServers = state.servers;
            displayServers(state.servers);
        }
        if (state.commands) {
            window.currentCommands = state.commands;
        }
    }
}

function clearState() {
    localStorage.removeItem(STATE_KEY);
}

// MOP Management
function loadMOPCommands() {
    const mopId = document.getElementById('mopSelect').value;
    if (!mopId) {
        document.getElementById('mopCommandsDisplay').style.display = 'none';
        document.getElementById('selectMOPBtn').style.display = 'none';
        return;
    }

    fetch(`/api/mops/${mopId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMOPCommands(data.mop);
                document.getElementById('selectedMOPName').textContent = data.mop.name;
                document.getElementById('mopCommandsDisplay').style.display = 'block';
                document.getElementById('selectMOPBtn').style.display = 'block';
                saveState();
            }
        })
        .catch(error => {
            console.error('Error loading MOP commands:', error);
            showAlert('error', 'Error loading MOP commands');
        });
}

function displayMOPCommands(mop) {
    const container = document.getElementById('commandsList');
    let html = `
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th style="width: 8%;">STT</th>
                        <th style="width: 25%;">Tên Command</th>
                        <th style="width: 42%;">Câu lệnh</th>
                        <th style="width: 25%;">Giá trị đối chiếu</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    mop.commands.forEach((command, index) => {
        html += `
            <tr>
                <td class="text-center font-weight-bold">${index + 1}</td>
                <td class="text-primary font-weight-bold">${command.title}</td>
                <td><pre class="bg-light p-2 rounded mb-0" style="font-size: 0.9em;">${command.command}</pre></td>
                <td><pre class="bg-light p-2 rounded mb-0" style="font-size: 0.9em;">${command.reference_value || 'N/A'}</pre></td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function selectCurrentMOP() {
    const mopId = document.getElementById('mopSelect').value;
    if (!mopId) {
        showAlert('warning', 'Please select a MOP first');
        return;
    }
    
    document.getElementById('selectedMopId').value = mopId;
    $('#mopExecutionModal').modal('show');
}

// Server Management
function showFileUpload() {
    $('#fileUploadModal').modal('show');
}

function showManualInput() {
    $('#manualInputModal').modal('show');
}

function showTestConnection() {
    $('#testConnectionModal').modal('show');
}

function uploadServerFile() {
    const fileInput = document.getElementById('serverFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('warning', 'Please select a file');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/api/upload/servers', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.currentServers = data.servers;
            displayServers(data.servers);
            $('#fileUploadModal').modal('hide');
            showAlert('success', `Successfully loaded ${data.servers.length} servers`);
            saveState();
        } else {
            showAlert('error', data.error || 'Error uploading file');
        }
    })
    .catch(error => {
        console.error('Error uploading file:', error);
        showAlert('error', 'Error uploading file');
    });
}

function addManualServer() {
    const server = {
        ip: document.getElementById('serverIP').value,
        admin_username: document.getElementById('adminUsername').value,
        admin_password: document.getElementById('adminPassword').value,
        root_username: document.getElementById('rootUsername').value,
        root_password: document.getElementById('rootPassword').value
    };
    
    if (!server.ip || !server.admin_username || !server.admin_password || 
        !server.root_username || !server.root_password) {
        showAlert('warning', 'Please fill all fields');
        return;
    }
    
    if (!window.currentServers) {
        window.currentServers = [];
    }
    
    window.currentServers.push(server);
    displayServers(window.currentServers);
    $('#manualInputModal').modal('hide');
    document.getElementById('manualServerForm').reset();
    showAlert('success', 'Server added successfully');
    saveState();
}

function testServerConnection() {
    const server = {
        ip: document.getElementById('serverIP').value,
        admin_username: document.getElementById('adminUsername').value,
        admin_password: document.getElementById('adminPassword').value,
        root_username: document.getElementById('rootUsername').value,
        root_password: document.getElementById('rootPassword').value
    };
    
    performConnectionTest(server);
}

function performConnectionTest(server = null) {
    if (!server) {
        server = {
            ip: document.getElementById('testServerIP').value,
            admin_username: document.getElementById('testAdminUsername').value,
            admin_password: document.getElementById('testAdminPassword').value,
            root_username: document.getElementById('testRootUsername').value,
            root_password: document.getElementById('testRootPassword').value
        };
    }
    
    if (!server.ip || !server.admin_username || !server.admin_password || 
        !server.root_username || !server.root_password) {
        showAlert('warning', 'Please fill all fields');
        return;
    }
    
    const resultDiv = document.getElementById('testResult');
    resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Testing connection...</div>';
    resultDiv.style.display = 'block';
    
    fetch('/api/servers/test-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(server)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Connection test successful!
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> Connection test failed: ${data.message}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error testing connection:', error);
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-times-circle"></i> Error testing connection
            </div>
        `;
    });
}

function displayServers(servers) {
    const container = document.getElementById('serverList');
    if (!servers || servers.length === 0) {
        container.innerHTML = '<p class="text-muted">No servers added yet</p>';
        return;
    }
    
    let html = '<div class="row">';
    servers.forEach((server, index) => {
        html += `
            <div class="col-md-6 mb-2">
                <div class="card">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${server.ip}</strong><br>
                                <small class="text-muted">${server.admin_username}</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeServer(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function removeServer(index) {
    window.currentServers.splice(index, 1);
    displayServers(window.currentServers);
    saveState();
}

// Execution
function executeMOP() {
    const mopId = document.getElementById('selectedMopId').value;
    if (!mopId) {
        showAlert('warning', 'Please select a MOP');
        return;
    }
    
    if (!window.currentServers || window.currentServers.length === 0) {
        showAlert('warning', 'Please add at least one server');
        return;
    }
    
    const serverIPs = window.currentServers.map(s => s.ip);
    
    fetch('/api/commands/run', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mop_id: mopId,
            server_ips: serverIPs,
            execution_type: 'handover_assessment'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#mopExecutionModal').modal('hide');
            showAlert('success', 'Execution started successfully');
            monitorExecution(data.job_id);
        } else {
            showAlert('error', data.error || 'Error starting execution');
        }
    })
    .catch(error => {
        console.error('Error starting execution:', error);
        showAlert('error', 'Error starting execution');
    });
}

function monitorExecution(jobId) {
    const checkStatus = () => {
        fetch(`/api/commands/status/${jobId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed') {
                    loadExecutionResults(jobId);
                } else if (data.status === 'failed') {
                    showAlert('error', 'Execution failed');
                } else {
                    setTimeout(checkStatus, 2000);
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                showAlert('error', 'Error checking execution status');
            });
    };
    
    checkStatus();
}

function loadExecutionResults(jobId) {
    fetch(`/api/commands/results/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayExecutionResults(data.results);
                $('#executionResultsModal').modal('show');
            } else {
                showAlert('error', 'Error loading results');
            }
        })
        .catch(error => {
            console.error('Error loading results:', error);
            showAlert('error', 'Error loading results');
        });
}

function displayExecutionResults(results) {
    const container = document.getElementById('executionResults');
    let html = `
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-info"><i class="fas fa-server"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Total Servers</span>
                        <span class="info-box-number">${results.summary.total_servers}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-success"><i class="fas fa-check"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Successful</span>
                        <span class="info-box-number">${results.summary.successful_servers}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-danger"><i class="fas fa-times"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Failed</span>
                        <span class="info-box-number">${results.summary.failed_servers}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-warning"><i class="fas fa-terminal"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Commands</span>
                        <span class="info-box-number">${results.summary.total_commands}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    Object.values(results.servers).forEach(server => {
        html += `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-server mr-2"></i>${server.ip}
                        <span class="badge badge-${server.status === 'success' ? 'success' : 'danger'} ml-2">
                            ${server.status}
                        </span>
                    </h6>
                </div>
                <div class="card-body">
        `;
        
        server.commands.forEach(command => {
            html += `
                <div class="command-result mb-3 p-3 border rounded">
                    <h6 class="text-primary">${command.title}</h6>
                    <div class="row">
                        <div class="col-md-12">
                            <strong>Command:</strong>
                            <pre class="bg-light p-2 rounded mt-1">${command.command}</pre>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Output:</strong>
                            <pre class="bg-light p-2 rounded mt-1">${command.output || 'No output'}</pre>
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong>
                            <span class="badge badge-${command.success ? 'success' : 'danger'}">
                                ${command.success ? 'Success' : 'Failed'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function exportResults() {
    // Implementation for exporting results
    showAlert('info', 'Export functionality will be implemented');
}

// showAlert function is now global in base.html
</script>
{% endblock %}
