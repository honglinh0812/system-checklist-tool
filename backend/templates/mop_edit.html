{% extends "base.html" %}

{% block title %}Edit MOP - System Checklist Tool{% endblock %}

{% block page_title %}Edit MOP{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('mop_review') }}">MOP Review</a></li>
<li class="breadcrumb-item active">Edit MOP</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-edit mr-2"></i>
                    Edit MOP: {{ mop.name }}
                </h3>
            </div>
            <div class="card-body">
                <form id="mopEditForm">
                    <input type="hidden" id="mopId" value="{{ mop.id }}">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="mopName"><strong>MOP Name:</strong></label>
                                <input type="text" class="form-control" id="mopName" value="{{ mop.name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Assessment Types:</strong></label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="riskAssessment" value="risk" {% if 'risk' in mop.type %}checked{% endif %}>
                                    <label class="form-check-label" for="riskAssessment">
                                        Risk Assessment
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="handoverAssessment" value="handover" {% if 'handover' in mop.type %}checked{% endif %}>
                                    <label class="form-check-label" for="handoverAssessment">
                                        Handover Assessment
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <h5><strong>Commands:</strong></h5>
                            <div id="commandsContainer">
                                {% for command in mop.commands %}
                                <div class="card mb-3 command-item" data-command-id="{{ loop.index }}">
                                    <div class="card-header">
                                        <div class="row align-items-center">
                                            <div class="col-md-11">
                                                <input type="text" class="form-control" name="commands[{{ loop.index }}][title]" 
                                                       value="{{ command.title }}" placeholder="Command Title" required>
                                            </div>
                                            <div class="col-md-1">
                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeCommand({{ loop.index }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><strong>Command:</strong></label>
                                                    <textarea class="form-control" name="commands[{{ loop.index }}][command]" 
                                                              rows="3" placeholder="Enter command" required>{{ command.command }}</textarea>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><strong>Reference Value:</strong></label>
                                                    <textarea class="form-control" name="commands[{{ loop.index }}][reference_value]" 
                                                              rows="3" placeholder="Expected output" required>{{ command.reference_value }}</textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <button type="button" class="btn btn-secondary" onclick="addCommand()">
                                <i class="fas fa-plus mr-2"></i>Add Command
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                            <button type="button" class="btn btn-success" onclick="approveMOP()">
                                <i class="fas fa-check mr-2"></i>Approve MOP
                            </button>
                            <a href="{{ url_for('mop_review') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Review
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">MOP Preview</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let commandCounter = {{ mop.commands|length }};

function addCommand() {
    commandCounter++;
    const commandHtml = `
        <div class="card mb-3 command-item" data-command-id="${commandCounter}">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-11">
                        <input type="text" class="form-control" name="commands[${commandCounter}][title]" 
                               placeholder="Command Title" required>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeCommand(${commandCounter})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label><strong>Command:</strong></label>
                            <textarea class="form-control" name="commands[${commandCounter}][command]" 
                                      rows="3" placeholder="Enter command" required></textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label><strong>Reference Value:</strong></label>
                            <textarea class="form-control" name="commands[${commandCounter}][reference_value]" 
                                      rows="3" placeholder="Expected output" required></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    $('#commandsContainer').append(commandHtml);
}

function removeCommand(id) {
    $(`.command-item[data-command-id="${id}"]`).remove();
}

function updatePreview() {
    const mopName = document.getElementById('mopName').value;
    const riskAssessment = document.getElementById('riskAssessment').checked;
    const handoverAssessment = document.getElementById('handoverAssessment').checked;
    
    const commands = [];
    $('.command-item').each(function() {
        const title = $(this).find('input[name*="[title]"]').val();
        const command = $(this).find('textarea[name*="[command]"]').val();
        const referenceValue = $(this).find('textarea[name*="[reference_value]"]').val();
        
        if (title && command && referenceValue) {
            commands.push({ title, command, reference_value: referenceValue });
        }
    });
    
    const previewContent = `
        <div class="row">
            <div class="col-md-12">
                <h5><strong>MOP Name:</strong> ${mopName}</h5>
                <h6><strong>Assessment Types:</strong></h6>
                <ul>
                    ${riskAssessment ? '<li>Risk Assessment</li>' : ''}
                    ${handoverAssessment ? '<li>Handover Assessment</li>' : ''}
                </ul>
                
                <h6><strong>Commands (${commands.length}):</strong></h6>
                ${commands.map((cmd, index) => `
                    <div class="command-preview-item mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-12">
                                <h6 class="text-primary">${index + 1}. ${cmd.title}</h6>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Command:</strong>
                                <pre class="bg-light p-2 rounded mt-1">${cmd.command}</pre>
                            </div>
                            <div class="col-md-6">
                                <strong>Reference Value:</strong>
                                <pre class="bg-light p-2 rounded mt-1">${cmd.reference_value}</pre>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    document.getElementById('previewContent').innerHTML = previewContent;
}

// Form submission
document.getElementById('mopEditForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        name: document.getElementById('mopName').value,
        type: []
    };
    
    if (document.getElementById('riskAssessment').checked) {
        data.type.push('risk');
    }
    if (document.getElementById('handoverAssessment').checked) {
        data.type.push('handover');
    }
    
    const commands = [];
    $('.command-item').each(function() {
        const title = $(this).find('input[name*="[title]"]').val();
        const command = $(this).find('textarea[name*="[command]"]').val();
        const referenceValue = $(this).find('textarea[name*="[reference_value]"]').val();
        
        if (title && command && referenceValue) {
            commands.push({
                title: title,
                command: command,
                reference_value: referenceValue
            });
        }
    });
    
    data.commands = commands;
    
    const mopId = document.getElementById('mopId').value;
    
    fetch(`/api/mops/${mopId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'MOP updated successfully');
        } else {
            showAlert('error', data.error || 'Failed to update MOP');
        }
    })
    .catch(error => {
        console.error('Error updating MOP:', error);
        showAlert('error', 'Error updating MOP');
    });
});

function approveMOP() {
    updatePreview();
    
    // Get form data
    const mopName = document.getElementById('mopName').value;
    const riskAssessment = document.getElementById('riskAssessment').checked;
    const handoverAssessment = document.getElementById('handoverAssessment').checked;
    
    const type = [];
    if (riskAssessment) type.push('risk');
    if (handoverAssessment) type.push('handover');
    
    const commands = [];
    $('.command-item').each(function() {
        const title = $(this).find('input[name*="[title]"]').val();
        const command = $(this).find('textarea[name*="[command]"]').val();
        const referenceValue = $(this).find('textarea[name*="[reference_value]"]').val();
        
        if (title && command && referenceValue) {
            commands.push({
                title: title,
                command: command,
                reference_value: referenceValue
            });
        }
    });
    
    const data = {
        name: mopName,
        type: type,
        commands: commands
    };
    
    const mopId = document.getElementById('mopId').value;
    
    // Show confirmation
    if (confirm('Are you sure you want to approve this MOP? This will make it available for execution.')) {
        fetch(`/api/mops/${mopId}/approve-final`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'MOP has been approved successfully');
                // Sleep 1 second before redirecting
                setTimeout(() => {
                    window.location.href = '/mop-management';
                }, 1000);
            } else {
                showAlert('error', data.error || 'Failed to approve MOP');
            }
        })
        .catch(error => {
            console.error('Error approving MOP:', error);
            showAlert('error', 'Error approving MOP');
        });
    }
}

// showAlert function is now global in base.html
</script>
{% endblock %}
