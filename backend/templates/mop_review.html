{% extends "base.html" %}

{% block title %}MOP Review - System Checklist Tool{% endblock %}

{% block page_title %}MOP Review{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">MOP Review</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-eye mr-2"></i>
                    Pending MOP Reviews
                </h3>
            </div>
            <div class="card-body">
                {% if pending_mops %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>MOP ID</th>
                                <th>Name</th>
                                <th>Submitted By</th>
                                <th>Submitted Date</th>
                                <th>Files</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mop in pending_mops %}
                            <tr>
                                <td><strong>#{{ mop.id }}</strong></td>
                                <td>{{ mop.name }}</td>
                                <td>{{ mop.creator.username if mop.creator else 'Unknown' }}</td>
                                <td>{{ mop.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>
                                    {% for file in mop.files %}
                                    <span class="badge badge-info mr-1">{{ file.file_type.upper() }}</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewMOPDetails({{ mop.id }})">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="approveMOPForEdit({{ mop.id }})">
                                        <i class="fas fa-edit mr-1"></i>Approve for Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectMOP({{ mop.id }})">
                                        <i class="fas fa-times mr-1"></i>Reject
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Pending MOPs</h5>
                    <p class="text-muted">All submitted MOPs have been reviewed.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- MOP Details Modal -->
<div class="modal fade" id="mopDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">MOP Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="mopDetailsContent">
                    <!-- MOP details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="approveCurrentMOPForEdit()">
                    <i class="fas fa-edit mr-2"></i>Approve for Edit
                </button>
                <button type="button" class="btn btn-danger" onclick="rejectCurrentMOP()">
                    <i class="fas fa-times mr-2"></i>Reject
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Reason Modal -->
<div class="modal fade" id="rejectReasonModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject MOP</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="rejectReason"><strong>Rejection Reason:</strong></label>
                    <textarea class="form-control" id="rejectReason" rows="4" placeholder="Please provide a reason for rejection..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmReject()">
                    <i class="fas fa-times mr-2"></i>Reject MOP
                </button>
            </div>
        </div>
    </div>
</div>

<!-- File Viewer Modal -->
<div class="modal fade" id="fileViewerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileViewerTitle">File Viewer</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div id="fileViewerContent">
                    <!-- File content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
window.currentMopId = null;

window.viewMOPDetails = function(mopId) {
    window.currentMopId = mopId;
    
    // Close any open file viewers
    $('#fileViewerModal').modal('hide');
    
    fetch(`/api/mops/${mopId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMOPDetails(data.mop);
                $('#mopDetailsModal').modal('show');
            } else {
                showAlert('error', 'Error loading MOP details');
            }
        })
        .catch(error => {
            console.error('Error loading MOP details:', error);
            showAlert('error', 'Error loading MOP details');
        });
}

function viewMOPFile(mopId, fileType) {
    // Hide the MOP details modal temporarily
    $('#mopDetailsModal').modal('hide');
    
    const fileUrl = `/api/mops/${mopId}/files/${fileType}`;
    const fileTitle = fileType.toUpperCase() + ' File';
    
    // Create content based on file type
    let viewerContent = '';
    
    if (fileType === 'pdf') {
        viewerContent = `
            <div class="embed-responsive embed-responsive-16by9" style="height: 70vh;">
                <iframe class="embed-responsive-item" src="${fileUrl}" allowfullscreen></iframe>
            </div>
        `;
    } else if (fileType === 'appendix') {
        // For Excel/CSV files, we can't embed them directly
        // Instead, show a message with download link
        viewerContent = `
            <div class="text-center py-5">
                <i class="fas fa-file-excel fa-4x text-success mb-3"></i>
                <h5>Excel/CSV files cannot be previewed directly</h5>
                <p>Please download the file to view its contents</p>
                <a href="${fileUrl}" class="btn btn-primary" target="_blank">
                    <i class="fas fa-download mr-2"></i>Download File
                </a>
            </div>
        `;
    }
    
    // Set modal content
    document.getElementById('fileViewerTitle').textContent = fileTitle;
    document.getElementById('fileViewerContent').innerHTML = viewerContent;
    
    // Show the file viewer modal
    $('#fileViewerModal').modal('show');
    
    // When file viewer is closed, show MOP details again
    $('#fileViewerModal').on('hidden.bs.modal', function () {
        $('#mopDetailsModal').modal('show');
    });
}

function displayMOPDetails(mop) {
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6><strong>MOP Information:</strong></h6>
                <table class="table table-sm">
                    <tr><td><strong>ID:</strong></td><td>${mop.id}</td></tr>
                    <tr><td><strong>Name:</strong></td><td>${mop.name}</td></tr>
                    <tr><td><strong>Status:</strong></td><td><span class="badge badge-warning">${mop.status}</span></td></tr>
                    <tr><td><strong>Created:</strong></td><td>${new Date(mop.created_at).toLocaleString()}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6><strong>Files:</strong></h6>
                <ul class="list-unstyled">
                    ${mop.files ? mop.files.map(file => {
                        const isAdmin = {{ current_user.is_admin() | tojson }};
                        const fileIcon = file.file_type === 'pdf' ? 'pdf' : 'excel';
                        const fileDate = new Date(file.uploaded_at).toLocaleDateString();
                        
                        if (isAdmin) {
                            return `
                                <li class="mb-2">
                                    <i class="fas fa-file-${fileIcon} mr-2"></i>${file.file_type.toUpperCase()} - ${fileDate}
                                    <div class="btn-group btn-group-sm ml-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewMOPFile(${mop.id}, '${file.file_type}')">
                                            <i class="fas fa-eye mr-1"></i>View
                                        </button>
                                        <a href="/api/mops/${mop.id}/files/${file.file_type}" class="btn btn-sm btn-outline-secondary" target="_blank">
                                            <i class="fas fa-download mr-1"></i>Download
                                        </a>
                                    </div>
                                </li>
                            `;
                        } else {
                            return `
                                <li>
                                    <i class="fas fa-file-${fileIcon} mr-2"></i>${file.file_type.toUpperCase()} - ${fileDate}
                                    <a href="/api/mops/${mop.id}/files/${file.file_type}" class="btn btn-sm btn-outline-secondary ml-2">
                                        <i class="fas fa-download mr-1"></i>Download
                                    </a>
                                </li>
                            `;
                        }
                    }).join('') : '<li>No files</li>'}
                </ul>
            </div>
        </div>
        
        ${mop.commands && mop.commands.length > 0 ? `
        <div class="row mt-3">
            <div class="col-md-12">
                <h6><strong>Commands:</strong></h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="thead-dark">
                            <tr>
                                <th style="width: 8%;">STT</th>
                                <th style="width: 25%;">Tên Command</th>
                                <th style="width: 35%;">Câu lệnh</th>
                                <th style="width: 32%;">Giá trị đối chiếu</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${mop.commands.map((cmd, index) => `
                                <tr>
                                    <td class="text-center">${index + 1}</td>
                                    <td><strong>${cmd.title}</strong></td>
                                    <td><code class="text-wrap">${cmd.command}</code></td>
                                    <td><small class="text-muted">${cmd.reference_value || 'N/A'}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        ` : ''}
    `;
    
    document.getElementById('mopDetailsContent').innerHTML = content;
}

function approveMOP(mopId) {
    if (confirm('Are you sure you want to approve this MOP?')) {
        reviewMOP(mopId, 'approve');
    }
}

function approveMOPForEdit(mopId) {
    if (confirm('Are you sure you want to approve this MOP for editing?')) {
        fetch(`/api/mops/${mopId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'MOP approved for editing');
                setTimeout(() => {
                    window.location.href = data.edit_url;
                }, 1500);
            } else {
                showAlert('error', data.error || 'Failed to approve MOP');
            }
        })
        .catch(error => {
            console.error('Error approving MOP:', error);
            showAlert('error', 'Error approving MOP');
        });
    }
}

function rejectMOP(mopId) {
    window.currentMopId = mopId;
    $('#rejectReasonModal').modal('show');
}

function approveCurrentMOP() {
    if (window.currentMopId) {
        reviewMOP(window.currentMopId, 'approve');
        $('#mopDetailsModal').modal('hide');
    }
}

function approveCurrentMOPForEdit() {
    if (window.currentMopId) {
        reviewMOP(window.currentMopId, 'approve_for_edit');
        $('#mopDetailsModal').modal('hide');
    }
}

function rejectCurrentMOP() {
    if (window.currentMopId) {
        $('#mopDetailsModal').modal('hide');
        $('#rejectReasonModal').modal('show');
    }
}

function confirmReject() {
    const reason = document.getElementById('rejectReason').value.trim();
    if (!reason) {
        showAlert('warning', 'Please provide a rejection reason');
        return;
    }
    
    if (window.currentMopId) {
        reviewMOP(window.currentMopId, 'reject', reason);
        $('#rejectReasonModal').modal('hide');
        document.getElementById('rejectReason').value = '';
    }
}

function reviewMOP(mopId, action, rejectReason = '') {
    const data = {
        action: action
    };
    
    if (action === 'reject') {
        data.reject_reason = rejectReason;
    }
    
    let endpoint = `/api/mops/${mopId}/review`;
    if (action === 'approve_for_edit') {
        endpoint = `/api/mops/${mopId}/approve`;
    }
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (action === 'approve_for_edit') {
                showAlert('success', 'MOP approved for editing');
                setTimeout(() => {
                    window.location.href = data.edit_url;
                }, 1500);
            } else {
                showAlert('success', `MOP ${action}d successfully`);
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        } else {
            showAlert('error', data.error || `Failed to ${action} MOP`);
        }
    })
    .catch(error => {
        console.error(`Error ${action}ing MOP:`, error);
        showAlert('error', `Error ${action}ing MOP`);
    });
}

// showAlert function is now global in base.html
</script>
{% endblock %}
